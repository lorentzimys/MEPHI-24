# Модуль 3. Виртуальные защищенные каналы связи, DMZ, Wi-Fi (HW)

## Лабораторная работа №1 (HW)

### Шаг 1. Подготовьте две виртуальные машины

В качестве сервера подготавливаем машину с Kali Linux:

**IP-адрес: 10.0.3.4**
![alt text](image-2.png)

Для клиентской машины подготовим Ubuntu:

**IP-адрес: 10.0.2.5**
![alt text](image-3.png)

### Шаг 2. Проведите настройку OpenVPN

Устанавливаем пакеты на сервер-хосте
![alt text](image-4.png)

**a: Cоздание инфраструктуры открытых ключей (PKI), центра сертификации;**

Создаем директорию для инфраструктуры публичных ключей и копируем туда все файлы пакета easy-rsa
![alt text](image-5.png)

Указание криптографических алгоритмов, которые будут использоваться при генерации ключей и подписей
![alt text](image-6.png)

Инициализация PKI
![alt text](image-8.png)

**b: Cоздание запроса сертификата и закрытого ключа сервера OpenVPN**
![alt text](image-9.png)

**с: Подпись запроса сертификата сервера OpenVPN**
Копируем ключ сервера в директорию конфигурации OpenVpn и подписываем запрос центром сертификации. Подписанный сертификат сервера kali.crt вместе с сертификатом центра сертификации копируем в директорию конфигурации OpenVPN**
![alt text](image-12.png)

**d: Настройка криптографических материалов OpenVPN**
Создаем ta.key и копируем его в директорию  сервера openvpn
![alt text](image-14.png)

Создаем и подписываем клиентский ключ и копируем все в директорию ключей клиентского конфига
![alt text](image-15.png)

**f: Настройка OpenVPN**
Настраиваем конфиг openvpn, добавляем параметры шифрования
![alt text](image-21.png)

**g: Настройка конфигурации сети сервера OpenVPN**
![alt text](image-17.png)

**h: Настройка межсетевого экрана**
![alt text](image-19.png)

**i: Запуск OpenVPN**
![alt text](image-20.png)

**j: Cоздание инфраструктуры конфигурации клиентских систем**

Копируем шаблон для создания клиентского конфига
![alt text](image-22.png)

Редактируем шаблон клиентского конфига

![alt text](image-23.png)

Создаем скрипт для создания .ovpn конфига из base.conf

![alt text](image-24.png)

**k: создание конфигураций клиентов**
Запускаем скрипт make_config.sh и генерируем файл конфига ubuntu.ovpn

![alt text](image-25.png)



**i: установка клиентской конфигурации**

Копируем .ovpn файл на клиентскую машину

![alt text](image-27.png)

Устанавливаем openvpn клиентскую службу

![alt text](image-28.png)

### Шаг 3. Проведите настройку WireGuard

Устанавливаем Wireguard на сервере
![alt text](image-32.png)

**a. генерация пары ключей для сервера Wireguard**
![alt text](image-33.png)

**b. создание файла конфигурации сервера**
![alt text](image-34.png)

**с. настройка межсетевого экрана**

Добавляем необходимые настройки в iptables
![alt text](image-35.png)

**d. запуск Wireguard**

Поднимаем wg-сервер
![alt text](image-36.png)

**e. генерация пары ключей для клиента Wireguard**

![alt text](image-37.png)

**f. создание файла конфигурации клиента**
**g. добавление публичного ключа клиента на сервер Wireguard**

![alt text](image-38.png)


### Шаг 4. Произведите соединение поочередно каждой из технологий. Замерьте скорость


#### OpenVPN

Подключаемся через openvpn
![alt text](image-29.png)

Соединение успешно установлено...

Пингуем адрес сервера, для проверки работы vpn
![alt text](image-30.png)

Сервер пингуется успешно...

Замеряем скорость соединения с помощью утилиты iperf
![alt text](image-31.png)

#### WireGuard

Подключаемся к wireguard серверу, проверяем пинг
![alt text](image-39.png)
Соединение успешно, пинг проходит...

Перед тем как замерить скорость - следует отключить ранее запущенный openvpn, проверяем что сервис openvpn выключен
![alt text](image-40.png)

Замеряем скорость соединения с помощью утилиты iperf
![alt text](image-45.png)

### Шаг 5. Сделайте выводы в соответствии с полученными результатами, основываясь на тонкостях двух изучаемых протоколов
Результатам сравнения скорости передачи данных с помощью утилиты **iperf** показали следующие результаты:

- Средняя скорость передачи данных через OpenVPN составила 1,38 Gb/sec

- Средняя скорость передачи данных через WireGuard составила 1,62 Gb/sec

Таким образом, практический замер скорости VPN-соединений данных протоколов подтверждает теоретическую информацию о том, что скорость передачи данных через WireGuard несколько выше.

WireGuard обычно быстрее, чем OpenVPN, благодаря меньшему коду, использованию современных криптографических алгоритмов и меньшему потреблению ресурсов. Он быстрее устанавливает соединение, имеет меньшие задержки и эффективнее работает на слабых устройствах

### Шаг 6. Произведите настройку технологии Port Knocking для порта OpenVPN

Устанавливаем knockd на сервер
![alt text](image-46.png)

Производим настройку пакетного фильтра
После некоторых неудачных попыток настроить пакетный фильтр, окончательный iptables выглядит следующим образом:

![alt text](image-51.png)

Где первые две строчки блокируют входящие tcp и udp пакеты на порт OpenVpn, в результате чего ни один ip-адрес не сможет установить соединение с OpenVpn сервером

Настраиваем конфиг knockd
![alt text](image-52.png)

Конфиг открывает порт 1194 для ip-адреса, с которого поступил запрос на tcp-соединение при правильном "простукивании" портов с таймаутом закрытия порта в 60 секунд.

Запускаем службу knockd и проверяем статус
![alt text](image-53.png)

### Шаг 7. Произведите подключение по OpenVPN с технологией Port Knocking, проверьте работоспособность

Для начала проверим что без простукивания портов VPN-соединение не сможет быть установлено. Для этого пробуем подключиться с VPN-серверу и видим, что статус нашего соединениея "завиает" в состоянии **Attempting to establish TCP connection with [AF_INET]10.0.3.4:1194**
Дальше ничего не происходит, сообщения об успешном подключении к VPN-серверу нету, так как на стороне сервера tcp-пакеты фильтруются.

![alt text](image-54.png)

Дальше "простукиваем" сервер заданной последовательностью **7000 8000 9000" и повторяем попытку подключения к OpenVpn серверу.
![alt text](image-55.png)

Видим, что соединение моментально установлено.

### Шаг 8. Просканируйте порт с помощью nmap до отправки последовательности и после, сравните результаты

Результаты сканирования порта 1194 с помощью TCP SCAN
![alt text](image-56.png)

Как видим, до простукивания состояние порта "filtered", что говорит нам о том, что порт блокируется межсетевым фильтром и ответные пакеты от сканируемого хоста не возвращаются обратно.

После простукивания состояние порта "open", что говорит нам о том, что порт открыт и пакеты успешно перемещаются между хостами

### Шаг 9. Посмотрите в Wireshark, как отправляются пакеты при подключении через Port Knocking

До "простукивания" пакеты в сети выглядят следующим образом  
![alt text](image-57.png)

1. Клиент отправляет SYN (первый пакет TCP handshake) на сервер.
2. Сервер не отвечает (firewall его просто дропает).
3. Клиент ждёт таймаут и повторяет SYN (TCP Retransmission).
4. Повторные SYN продолжаются несколько раз 

А вот как выглядит "простукивание" портов с помощью port-knocking

![alt text](image-58.png)
До установления соединения с OpenVpn сервером идут 3 TCP-пакета на порты 7000, 8000 и 9000 соотвтественно.
После этого мы видим успешное tcp-соединение и дальше пакеты по протоколу OpenVPN передаются между клиентом и сервером